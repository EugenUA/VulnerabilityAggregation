package service.vulnerabilities_aggregation.Preprocessing.CreatingEntities;

import entities.programEntities.Email;
import entities.programEntities.miningEntities.PreprocessingEntity;

import java.util.ArrayList;

public class EmailsPreprocessing{

    ArrayList<Email> emails;
    ArrayList<PreprocessingEntity> preprocessingEntities = new ArrayList<PreprocessingEntity>();

    public EmailsPreprocessing(ArrayList<Email> receivedEmails){
        this.emails = receivedEmails;
    }

    public ArrayList<PreprocessingEntity> getPreprocessingEntities() {
        return preprocessingEntities;
    }

    public void createEmailEntitiesForPreprocessing(){
        for(Email eachEmail : emails){
            if(eachEmail.getSubject().contains("[FD]")){        //from full-disclosure

                PreprocessingEntity emailPreprocessing = new PreprocessingEntity();

                String shortResult = eachEmail.getSubject().substring(eachEmail.getSubject().indexOf("FD")+3,
                        eachEmail.getSubject().indexOf(eachEmail.getSubject().length()));
                String longResult = eachEmail.getContent();

                emailPreprocessing.setOriginalMessage(eachEmail.getContent());
                emailPreprocessing.setShortDescription(shortResult);
                emailPreprocessing.setLongDescription(longResult);
                emailPreprocessing.setSource("Full-disclosure");

                preprocessingEntities.add(emailPreprocessing);
            }
            if(eachEmail.getSubject().contains("[gentoo-announce]")){ // from gentoo security

                PreprocessingEntity emailPreprocessing = new PreprocessingEntity();

                String shortResult = eachEmail.getContent().substring(eachEmail.getContent().indexOf("Synopsis")+19,
                        eachEmail.getContent().indexOf("Background")-2);
                String longResult = eachEmail.getContent().substring(eachEmail.getContent().indexOf("Description")+25,
                        eachEmail.getContent().indexOf("Impact")-2);

                emailPreprocessing.setOriginalMessage(eachEmail.getContent());
                emailPreprocessing.setShortDescription(shortResult);
                emailPreprocessing.setLongDescription(longResult);
                emailPreprocessing.setSource("Gentoo Security");

                preprocessingEntities.add(emailPreprocessing);
            }
            if(eachEmail.getSubject().contains("Security-announce") || eachEmail.getSubject().contains("VMware")){ // from VMware
                String vmWareVulnerabilities = eachEmail.getContent().substring(eachEmail.getContent().indexOf("3. Problem Description") + 24,
                        eachEmail.getContent().indexOf("4. Solution")-2);
                for(int i = 97; i < 122; i++) {
                    PreprocessingEntity emailPreprocessing = new PreprocessingEntity();
                    if (vmWareVulnerabilities.contains(Character.toString((char) i) + ".")) {
                        String shortResult = vmWareVulnerabilities.substring(vmWareVulnerabilities.indexOf(Character.toString((char) i) + "."),
                                vmWareVulnerabilities.indexOf(Character.toString((char) i) + ".") +
                                        vmWareVulnerabilities.substring(vmWareVulnerabilities.indexOf(Character.toString((char) i) + ".")).indexOf("\n"));
                        //System.out.println(shortResult);

                        int j = i + 1;
                        int nextPos = 0;
                        if (vmWareVulnerabilities.contains(Character.toString((char) j) + ".")) {
                            nextPos = vmWareVulnerabilities.indexOf(Character.toString((char) j) + ".");
                        }

                        String longResult;
                        if (nextPos != 0) {
                            longResult = vmWareVulnerabilities.substring(vmWareVulnerabilities.indexOf(Character.toString((char) i) + "."),
                                    nextPos);
                        } else {
                            longResult = vmWareVulnerabilities.substring(vmWareVulnerabilities.indexOf(Character.toString((char) i) + "."));
                        }
                        //System.out.println(longResult);

                        emailPreprocessing.setOriginalMessage(eachEmail.getContent());
                        emailPreprocessing.setShortDescription(shortResult);
                        emailPreprocessing.setLongDescription(longResult);
                        emailPreprocessing.setSource("VMware Security Announce");

                        preprocessingEntities.add(emailPreprocessing);
                    } else {
                        break;
                    }
                }
            }
        }
    }
}